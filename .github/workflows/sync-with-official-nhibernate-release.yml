name: Sync NHibernate Repository with official release

on:
  schedule:
    - cron: "0 1 * * *" # Runs daily at 1:00 AM UTC
  workflow_dispatch:

jobs:
  sync_fork:
    name: Sync Fork with Upstream
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout configit-open-source/nhibernate-core
        uses: actions/checkout@v4
        with:
          repository: configit-open-source/nhibernate-core
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/nhibernate/nhibernate-core.git
          git fetch upstream

      - name: Sync master branch
        run: |
          git checkout master
          git merge upstream/master --no-ff -m "Merge upstream changes from nhibernate/nhibernate-core" || git merge upstream/master -m "Merge upstream changes from nhibernate/nhibernate-core"

          # Remove workflow changes and amend the merge commit if workflows were modified
          if git diff HEAD~1 HEAD --name-only | grep -q '^.github/workflows/'; then
            git checkout HEAD~1 -- .github/workflows/
            git commit --amend --no-edit
          fi

      - name: Push Changes to Fork
        run: git push origin master

      - name: Create summary
        if: always()
        run: |
          echo "## NHibernate Fork Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "Forked repository: configit-open-source/nhibernate-core" >> $GITHUB_STEP_SUMMARY
          echo "Upstream repository: nhibernate/nhibernate-core" >> $GITHUB_STEP_SUMMARY
          echo "Sync completed at: $(date)" >> $GITHUB_STEP_SUMMARY
